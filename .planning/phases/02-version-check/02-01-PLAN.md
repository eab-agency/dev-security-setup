---
phase: 02-version-check
type: execute
---

<objective>
Add version-check alerting that queries GitHub releases and warns users when they're running an outdated version — replacing the removed git-pull auto-update with a non-blocking, cached check.

Purpose: Security tools must stay current. Users need to know when they're running outdated secret detection so they can upgrade. This replaces the old git-pull auto-update that was removed for Homebrew distribution.
Output: `setup-security.sh` with a `check_for_updates()` function that silently queries GitHub releases, caches results for 24 hours, and prints a yellow warning with upgrade instructions when a newer version exists.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/01-script-preparation/01-01-SUMMARY.md

# Research findings:
@.planning/phases/02-version-check/02-RESEARCH.md

# Source file:
@setup-security.sh

**Tech stack available:** bash, curl, grep, sed, sort -V
**Established patterns:** CLI flag convention: --long-form|-short for all flags
**Constraining decisions:**
- Phase 1: v3.0.0 major bump — VERSION="3.0.0" on line 5
- Phase 1: --version flag exists, version_gte() function exists on line 72-74

**From research — DO NOT hand-roll:**
- Version comparison: reuse existing `version_gte()` function (line 72-74)
- JSON parsing approach: grep+sed (no jq dependency)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add check_for_updates function with caching</name>
  <files>setup-security.sh</files>
  <action>
  Add a `check_for_updates()` function after the `version_gte()` function (after line 74) and before the version-file check block (line 77). The function must:

  1. **Cache variables** (define above the function, after line 8):
     ```
     UPDATE_CHECK_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/setup-security"
     UPDATE_CHECK_CACHE_FILE="$UPDATE_CHECK_CACHE_DIR/latest-version"
     UPDATE_CHECK_INTERVAL=86400
     ```

  2. **Function body** — `check_for_updates()`:
     - First check if cache file exists and is fresh (modified within last 24h / 86400s). Use `stat -f %m` with fallback to `stat -c %Y` for macOS/Linux portability. If cache is fresh, read the cached version from file instead of hitting API.
     - If cache is stale or missing, query `https://api.github.com/repos/eab-agency/dev-security-setup/releases/latest` with `curl -sL --connect-timeout 3 --max-time 5`. Parse `tag_name` using `grep '"tag_name"'` piped to `sed -E 's/.*"v?([^"]+)".*/\1/'`. If curl fails or parsing returns empty, return silently (never block).
     - On successful fetch, cache the result: `mkdir -p "$UPDATE_CHECK_CACHE_DIR" && echo "$latest" > "$UPDATE_CHECK_CACHE_FILE"`.
     - Compare cached/fetched version against `$VERSION` using existing `version_gte()`. If current version is older, print:
       ```
       echo -e "${YELLOW}Update available: v$latest (current: v$VERSION)${NC}"
       echo -e "${YELLOW}Run: brew upgrade dev-security-setup${NC}"
       echo ""
       ```

  **Critical constraints:**
  - The entire function must be wrapped to never cause script failure: use `|| true` or subshell. The script has `set -e` on line 2 — any unhandled failure in this function would kill the script. Wrap the function call (not the definition) with `|| true`.
  - Network timeout must be short (3s connect, 5s total) — users should not notice delay.
  - Do NOT add jq as a dependency. Use grep+sed only.
  - Do NOT modify the existing `version_gte()` function.
  </action>
  <verify>
  1. `grep -c 'check_for_updates' setup-security.sh` returns at least 2 (function definition + call)
  2. `grep 'connect-timeout' setup-security.sh` shows the curl timeout flags
  3. `grep 'UPDATE_CHECK_CACHE' setup-security.sh` shows cache variables
  4. `grep 'brew upgrade' setup-security.sh` shows the upgrade instruction
  5. `bash -n setup-security.sh` exits 0 (syntax check passes)
  </verify>
  <done>check_for_updates() function exists with: GitHub API query, grep+sed parsing, 24h file-based cache, stat portability, silent failure on network/parse errors, yellow warning output with brew upgrade instruction</done>
</task>

<task type="auto">
  <name>Task 2: Integrate version check into script startup</name>
  <files>setup-security.sh</files>
  <action>
  Add the `check_for_updates` call after the banner output (after line 63's empty echo) and before the git repository check (line 66). Place it as:

  ```
  # Check for updates (non-blocking, cached)
  check_for_updates || true
  ```

  The `|| true` ensures `set -e` does not kill the script if anything inside the function fails unexpectedly.

  **Placement rationale** (from research): User sees current version in the banner first, then immediately sees if an update is available, before any real work begins.

  Do NOT move the function definition — it stays near `version_gte()`. Only add the CALL here.
  </action>
  <verify>
  1. `bash setup-security.sh --version` still works (exits before update check)
  2. `bash -n setup-security.sh` exits 0 (syntax valid)
  3. Read the script and confirm the call is between the banner and the git check
  4. Run `bash setup-security.sh --help` to confirm help still works
  </verify>
  <done>check_for_updates is called after banner, before git check, with || true guard. Script startup flow: banner → update check → git check → dependency checks → setup</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bash -n setup-security.sh` passes (no syntax errors)
- [ ] `bash setup-security.sh --version` prints version and exits
- [ ] `bash setup-security.sh --help` lists all flags
- [ ] `grep 'check_for_updates' setup-security.sh` shows function definition and call
- [ ] `grep 'set -e' setup-security.sh` confirms error handling still intact
- [ ] The check_for_updates function has curl timeout flags (--connect-timeout 3 --max-time 5)
- [ ] The function call has `|| true` guard against set -e
- [ ] Cache uses XDG_CACHE_HOME with $HOME/.cache fallback
- [ ] stat command handles both macOS (-f %m) and Linux (-c %Y)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Version check is fully non-blocking (never kills script on failure)
- Cache prevents excessive API calls (24-hour interval)
- No new dependencies introduced (no jq, no extra tools)
- Existing flags and behavior unchanged
- Phase 2 complete (covers both 02-01 and 02-02 from roadmap)
</success_criteria>

<output>
After completion, create `.planning/phases/02-version-check/02-01-SUMMARY.md`
</output>
